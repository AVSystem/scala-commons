name: Test Compilation Benchmark

on:
  pull_request:
    branches: ['**']
  workflow_dispatch: {}

jobs:
  benchmark:
    name: Compilation Benchmark
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: temurin

      - name: Setup sbt
        uses: sbt/setup-sbt@v1

      - name: Install Hyperfine
        run: |
          sudo apt-get update
          sudo apt-get install -y hyperfine

      - name: Run Benchmarks
        id: benchmark
        run: |
          set -e
          
          echo "::group::Benchmarking Scala 3"
          hyperfine --runs 5 --warmup 2 --prepare "sbt benchmark-compilation3/clean benchmark-compilation3/update" "sbt benchmark-compilation3/compile" --export-json "scala3.json"
          
          echo "::group::Benchmarking Scala 2"          
          hyperfine --runs 5 --warmup 2 --prepare "sbt benchmark-compilation2/clean benchmark-compilation2/update" "sbt benchmark-compilation2/compile" --export-json "scala2.json"

      - name: Extract Results
        id: extract
        run: |
          echo "scala2_mean=$(jq '.results[0].mean' scala2.json)" >> $GITHUB_OUTPUT
          echo "scala3_mean=$(jq '.results[0].mean' scala3.json)" >> $GITHUB_OUTPUT

      - name: Upload Benchmark Results
        uses: actions/upload-artifact@v4
        with:
          name: compilation-benchmark-results
          path: |
            scala2.json
            scala3.json

      - name: Print Results Summary
        run: |
          echo "=== Compilation Benchmark Results ==="
          echo ""
          echo "Scala 2.13: ${{ steps.extract.outputs.scala2_mean }}s"
          echo "Scala 3:    ${{ steps.extract.outputs.scala3_mean }}s"
          echo ""
          scala2_mean=${{ steps.extract.outputs.scala2_mean }}
          scala3_mean=${{ steps.extract.outputs.scala3_mean }}
          diff=$(echo "$scala3_mean - $scala2_mean" | bc -l)
          perc=$(echo "scale=2; ($diff / $scala2_mean) * 100" | bc -l)
          echo "Difference: ${diff}s (${perc}%)"
          if (( $(echo "$perc > 1" | bc -l) )); then
            echo "Status: Scala 3 is slower ‚ö†Ô∏è"
          elif (( $(echo "$perc < -1" | bc -l) )); then
            echo "Status: Scala 3 is faster ‚úÖ"
          else
            echo "Status: Performance is similar ‚ÑπÔ∏è"
          fi

      - name: Upsert PR Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        env:
          SCALA_2_MEAN: ${{ steps.extract.outputs.scala2_mean }}
          SCALA_3_MEAN: ${{ steps.extract.outputs.scala3_mean }}
        with:
          script: |
            const scala2Mean = parseFloat(process.env.SCALA_2_MEAN);
            const scala3Mean = parseFloat(process.env.SCALA_3_MEAN);
            
            const diff = scala3Mean - scala2Mean;
            const perc = (diff / scala2Mean) * 100;
            
            const diffAbs = Math.abs(diff).toFixed(3);
            const percAbs = Math.abs(perc).toFixed(2);
            
            let status = 'faster';
            let emoji = '‚úÖ';
            if (perc > 1) {
              status = 'slower';
              emoji = '‚ö†Ô∏è';
            } else if (Math.abs(perc) <= 1) {
              status = 'unchanged';
              emoji = '‚ÑπÔ∏è';
            }

            const body = [
              '### üìä Test Compilation Benchmark',
              '',
              '| Scala Version | Average Time |',
              '| :--- | :--- |',
              `| **Scala 2.13** | ${scala2Mean.toFixed(3)}s |`,
              `| **Scala 3** | ${scala3Mean.toFixed(3)}s |`,
              '',
              `**Result:** Scala 3 is **${diffAbs}s ${status}** (${percAbs}%) ${emoji}`
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c => c.body.includes('### üìä Test Compilation Benchmark'));

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
